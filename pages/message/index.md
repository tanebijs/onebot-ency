# 消息

消息是 OneBot 11 标准中一个重要的数据类型，在发送消息的 API 和接收消息的事件中都有相关字段。OneBot 11 规定了消息的两种表示形式：字符串（string）格式和数组（array）格式。

## 基础概念

消息的基本构成单位是消息段，有不同的**类型**（type，OneBot 11 称之为功能名），并且每个类型都有自己特有的**数据**（data，OneBot 11 称之为参数），遵循键-值对的形式。消息段的类型和数据共同构成了消息段的内容。

例如，文本（text）类型的数据有一个键值对，键为 `text`，值为文本内容，用 JSON 格式表示如下：

```json
{
  "type": "text",
  "data": {
    "text": "Hello, world!"
  }
}
```

QQ 的消息类型分为很多种，例如文本消息、图片消息、表情消息、语音消息等。但有的可以混合在一起，有的则不能混合在一起，只能单独发送。OneBot 本身并不限制消息段的组合方式，但协议端可能会限制消息段的组合方式，笔者按照能否混合发送，以及消息本身的类型，将消息段分为三类：

- [富文本消息段](/message/segment/rich)：出现在 QQ 的聊天气泡内，可以混合发送的消息段，例如文本、图片、表情等。
- [媒体消息段](/message/segment/media)：单独作为一条消息，不能混合发送的消息段，例如语音、视频等。
- [广义消息段](/message/segment/broad)：在 QQ 客户端不以消息的形式出现，但仍然位于 OneBot 11 标准中的消息段，例如文件、戳一戳。

同时需注意，不同的协议端对消息段的支持程度不同。此外，某些消息段对应的功能已经过时，或已经被严重风控，在协议端的支持并不佳，建议谨慎使用。

## 字符串表示

消息的字符串格式脱胎自 CQ 码，除文本外，其他类型的消息段都用一对方括号 `[]` 包裹起来，基本格式为：

```
[CQ:类型,参数1=值1,参数2=值2,...]
```

CQ 码中不应有多余的空格，例如不应该使用 `[CQ:face, id=178]`。

CQ 码的参数值可以包含空格、换行、除 `[],&` 之外的特殊符号等。在解析时，应直接取 `[CQ:` 后、第一个 `,` 或 `]` 前的部分为功能名，第一个 `,` 之后到 `]` 之间的部分为参数，按 `,` 分割后，每个部分第一个 `=` 前的内容为参数名，之后的部分为参数值。例如 `[CQ:share,title=标题中有=等号,url=http://baidu.com]` 中，功能名为 `share`，`title` 参数值为 `标题中有=等号`，`url` 参数值为 `http://baidu.com`。

::: details 一点碎碎念
遗憾的是，CQ 码这样的编码格式被**严重滥用**了，很多开发者（尤其是易语言开发者）完全没有按照上面的逻辑去解析 CQ 码，造成了很大的适配困难。比如，`at` 的参数只包含一个字段 `qq`，因此其标准的 CQ 码格式应该形如 `[CQ:at,qq=123]`，因此一些开发者通过搜索 `[CQ:at,qq=` 的结束位置和 `]` 的开始位置，然后取二者之间的内容作为被 at 的 QQ 号。NapCatQQ 曾经为 `at` 增加了一个扩展字段 `name`，这样编码而成的 CQ 码就变成了 `[CQ:at,qq=123,name=小明]`，这样通过上面方式解析就会得到 `123,name=小明`，而不是 `123`。NapCatQQ 后续被迫回滚了这个功能。
:::

### 转义

CQ 码中包含一些特殊字符：`[`、`]`、`,` 等，而 CQ 码又是可能混杂在纯文本内容之中的，因此消息中的纯文本内容需要对特殊字符进行转义，以避免歧义。具体的转义规则如下：

| 转义前 | 转义后  |
| ------ | ------- |
| `&`    | `&amp;` |
| `[`    | `&#91;` |
| `]`    | `&#93;` |

例如，一个纯文本消息转义前内容如下：

```
- [x] 使用 `&data` 获取地址
```

转义后如下：

```
- &#91;x&#93; 使用 `&amp;data` 获取地址
```

另一方面，CQ 码内部的参数值也可能出现特殊字符，也是需要转义的。由于 `,`（半角逗号）在 CQ 码中用于分隔参数，因此除了上面的转义规则，还需要对 `,` 进行转义，如下：

| 转义前 | 转义后  |
| ------ | ------- |
| `&`    | `&amp;` |
| `[`    | `&#91;` |
| `]`    | `&#93;` |
| `,`    | `&#44;` |

## 数组表示

数组格式将消息表示为一系列消息段对象的数组，在基本语义上与字符串格式等价，可以相互转换，但数组格式的表达能力更强，例如可以嵌套、规定参数数据类型等。用 JSON 表示的一个消息段基本格式如下：

```json
{
  "type": "类型",
  "data": {
    "参数1": "值1",
    "参数2": "值2",
    "...": "..."
  }
}
```

这与上面的示例 CQ 码等价。

因此，将一个个 JSON 表示的消息段拼合起来，就可以得到一个完整的消息段数组，例如，CQ 码为

```
Hello, world![CQ:face,id=178][CQ:at,qq=123456789]
```

的一条消息，用数组格式表示就是：

```json
[
  {
    "type": "text",
    "data": {
      "text": "Hello, world!"
    }
  },
  {
    "type": "face",
    "data": {
      "id": 178
    }
  },
  {
    "type": "at",
    "data": {
      "qq": 123456789
    }
  }
]
```

::: details 最佳实践
在条件允许的情况下，我们更推荐使用数组格式来表示消息段，因为它的表达能力更强，且更易于解析。**并且，协议端对数组格式的支持也更加完善。**
:::
